<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>API Test Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      .panel {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      button {
        padding: 10px;
        margin: 5px;
        background: #007bff;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 4px;
      }
      pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .result {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 10px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      input[type="file"] {
        display: block;
        margin: 10px 0;
      }
      .header-control {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }
      .header-control input {
        flex: 1;
        margin-right: 10px;
        padding: 5px;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 15px;
        cursor: pointer;
        background: #eee;
        border: 1px solid #ddd;
        border-bottom: none;
        margin-right: 5px;
      }
      .tab.active {
        background: white;
        border-bottom: 1px solid white;
      }
      .tab-content {
        display: none;
        border: 1px solid #ddd;
        padding: 15px;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Wildlife Threat Detection API Test</h1>
    <p>This page tests API requests to debug malformed HTTP issues.</p>

    <div class="tabs">
      <div class="tab active" data-tab="tab1">Basic Tests</div>
      <div class="tab" data-tab="tab2">Image Upload</div>
      <div class="tab" data-tab="tab3">Audio Upload</div>
      <div class="tab" data-tab="tab4">Advanced Tests</div>
    </div>

    <div id="tab1" class="tab-content active">
      <div class="panel">
        <h2>Test 1: Standard Fetch</h2>
        <button id="test1">Run Test</button>
        <div id="result1" class="result">Results will appear here...</div>
      </div>

      <div class="panel">
        <h2>Test 2: Fetch with Headers</h2>
        <button id="test2">Run Test</button>
        <div id="result2" class="result">Results will appear here...</div>
      </div>
    </div>

    <div id="tab2" class="tab-content">
      <div class="panel">
        <h2>Test 3: Image Upload Test</h2>
        <p>Upload an image to test the /analyze-image/ endpoint</p>
        <input type="file" id="imageFile" accept="image/*" />
        <div>
          <button id="sendImageFetch">Test with Fetch</button>
          <button id="sendImageXHR">Test with XMLHttpRequest</button>
        </div>
        <div id="imageResult" class="result">Results will appear here...</div>
      </div>
    </div>

    <div id="tab3" class="tab-content">
      <div class="panel">
        <h2>Test 4: Audio Upload Test</h2>
        <p>Upload an audio file to test the /analyze-audio/ endpoint</p>
        <input type="file" id="audioFile" accept="audio/wav" />
        <div>
          <button id="sendAudioFetch">Test with Fetch</button>
          <button id="sendAudioXHR">Test with XMLHttpRequest</button>
        </div>
        <div id="audioResult" class="result">Results will appear here...</div>
      </div>
    </div>

    <div id="tab4" class="tab-content">
      <div class="panel">
        <h2>Test 5: Custom Request Test</h2>
        <p>Customize headers and other request parameters</p>

        <div>
          <label>API Endpoint:</label>
          <select id="endpoint">
            <option value="/">Root Endpoint</option>
            <option value="/analyze-image/">Analyze Image</option>
            <option value="/analyze-audio/">Analyze Audio</option>
          </select>
        </div>

        <div>
          <label>Method:</label>
          <select id="method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="OPTIONS">OPTIONS</option>
          </select>
        </div>

        <div>
          <label>Custom Headers:</label>
          <div id="headerContainer">
            <div class="header-control">
              <input type="text" class="headerName" placeholder="Header name" />
              <input
                type="text"
                class="headerValue"
                placeholder="Header value"
              />
              <button class="removeHeader">-</button>
            </div>
          </div>
          <button id="addHeader">Add Header</button>
        </div>

        <div>
          <label>File Upload:</label>
          <input type="file" id="customFile" />
        </div>

        <div>
          <button id="sendCustomFetch">Send Request with Fetch</button>
          <button id="sendCustomXHR">Send Request with XMLHttpRequest</button>
        </div>

        <div id="customResult" class="result">Results will appear here...</div>
      </div>
    </div>

    <script>
      // API endpoints - try both direct and proxy
      const DIRECT_API = "http://localhost:8000";
      const PROXY_API = "http://localhost:8888";

      // Choose which to use
      const API_BASE = DIRECT_API;

      // Helper function to display results
      function displayResult(elementId, data, isError = false) {
        const element = document.getElementById(elementId);
        element.innerHTML =
          '<pre class="' +
          (isError ? "error" : "success") +
          '">' +
          JSON.stringify(data, null, 2) +
          "</pre>";
      }

      // Tab switching
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          // Remove active class from all tabs and contents
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          // Add active class to selected tab
          tab.classList.add("active");
          document.getElementById(tab.dataset.tab).classList.add("active");
        });
      });

      // Test 1: Standard Fetch
      document.getElementById("test1").addEventListener("click", async () => {
        try {
          const startTime = Date.now();
          const response = await fetch(`${API_BASE}/`);
          const data = await response.json();
          const endTime = Date.now();

          displayResult("result1", {
            timeMs: endTime - startTime,
            status: response.status,
            statusText: response.statusText,
            headers: Object.fromEntries([...response.headers.entries()]),
            data,
          });
        } catch (error) {
          displayResult(
            "result1",
            {
              error: error.message,
              stack: error.stack,
            },
            true
          );
        }
      });

      // Test 2: Fetch with Headers
      document.getElementById("test2").addEventListener("click", async () => {
        try {
          const startTime = Date.now();
          const response = await fetch(`${API_BASE}/`, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "User-Agent": "Test/1.0",
              "X-Custom-Header": "TestValue",
              "Cache-Control": "no-cache",
            },
            cache: "no-cache",
          });
          const data = await response.json();
          const endTime = Date.now();

          displayResult("result2", {
            timeMs: endTime - startTime,
            status: response.status,
            statusText: response.statusText,
            headers: Object.fromEntries([...response.headers.entries()]),
            data,
          });
        } catch (error) {
          displayResult(
            "result2",
            {
              error: error.message,
              stack: error.stack,
            },
            true
          );
        }
      });

      // Test 3: Image Upload
      document
        .getElementById("sendImageFetch")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("imageFile");

          if (!fileInput.files.length) {
            displayResult(
              "imageResult",
              { error: "Please select an image file first" },
              true
            );
            return;
          }

          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append("file", file);

          try {
            const startTime = Date.now();

            const response = await fetch(`${API_BASE}/analyze-image/`, {
              method: "POST",
              headers: {
                Accept: "application/json",
                // Do not set Content-Type when sending FormData
              },
              cache: "no-cache",
              mode: "cors",
              body: formData,
            });

            let data;
            try {
              data = await response.json();
            } catch (e) {
              data = { rawText: await response.text() };
            }

            const endTime = Date.now();

            displayResult("imageResult", {
              timeMs: endTime - startTime,
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries([...response.headers.entries()]),
              data,
            });
          } catch (error) {
            displayResult(
              "imageResult",
              {
                error: error.message,
                stack: error.stack,
              },
              true
            );
          }
        });

      document.getElementById("sendImageXHR").addEventListener("click", () => {
        const fileInput = document.getElementById("imageFile");

        if (!fileInput.files.length) {
          displayResult(
            "imageResult",
            { error: "Please select an image file first" },
            true
          );
          return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        const xhr = new XMLHttpRequest();
        const startTime = Date.now();

        xhr.open("POST", `${API_BASE}/analyze-image/`);
        xhr.setRequestHeader("Accept", "application/json");

        xhr.onload = function () {
          const endTime = Date.now();
          try {
            const data = JSON.parse(xhr.responseText);

            // Get response headers
            const headerString = xhr.getAllResponseHeaders();
            const headerArray = headerString.split("\r\n");
            const headers = {};
            headerArray.forEach((line) => {
              if (line) {
                const parts = line.split(": ");
                const header = parts.shift();
                const value = parts.join(": ");
                headers[header] = value;
              }
            });

            displayResult("imageResult", {
              timeMs: endTime - startTime,
              status: xhr.status,
              statusText: xhr.statusText,
              headers: headers,
              data,
            });
          } catch (error) {
            displayResult(
              "imageResult",
              {
                error: error.message,
                response: xhr.responseText,
                status: xhr.status,
                statusText: xhr.statusText,
              },
              true
            );
          }
        };

        xhr.onerror = function () {
          const endTime = Date.now();
          displayResult(
            "imageResult",
            {
              error: "Network Error",
              status: xhr.status,
              timeMs: endTime - startTime,
            },
            true
          );
        };

        xhr.send(formData);
      });

      // Add similar event listeners for audio upload
      document
        .getElementById("sendAudioFetch")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("audioFile");

          if (!fileInput.files.length) {
            displayResult(
              "audioResult",
              { error: "Please select an audio file first" },
              true
            );
            return;
          }

          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append("file", file);

          try {
            const startTime = Date.now();

            const response = await fetch(`${API_BASE}/analyze-audio/`, {
              method: "POST",
              headers: {
                Accept: "application/json",
              },
              cache: "no-cache",
              mode: "cors",
              body: formData,
            });

            let data;
            try {
              data = await response.json();
            } catch (e) {
              data = { rawText: await response.text() };
            }

            const endTime = Date.now();

            displayResult("audioResult", {
              timeMs: endTime - startTime,
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries([...response.headers.entries()]),
              data,
            });
          } catch (error) {
            displayResult(
              "audioResult",
              {
                error: error.message,
                stack: error.stack,
              },
              true
            );
          }
        });

      document.getElementById("sendAudioXHR").addEventListener("click", () => {
        // Similar implementation as sendImageXHR but for audio files
        const fileInput = document.getElementById("audioFile");

        if (!fileInput.files.length) {
          displayResult(
            "audioResult",
            { error: "Please select an audio file first" },
            true
          );
          return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        const xhr = new XMLHttpRequest();
        const startTime = Date.now();

        xhr.open("POST", `${API_BASE}/analyze-audio/`);
        xhr.setRequestHeader("Accept", "application/json");

        xhr.onload = function () {
          const endTime = Date.now();
          try {
            const data = JSON.parse(xhr.responseText);

            // Get response headers
            const headerString = xhr.getAllResponseHeaders();
            const headerArray = headerString.split("\r\n");
            const headers = {};
            headerArray.forEach((line) => {
              if (line) {
                const parts = line.split(": ");
                const header = parts.shift();
                const value = parts.join(": ");
                headers[header] = value;
              }
            });

            displayResult("audioResult", {
              timeMs: endTime - startTime,
              status: xhr.status,
              statusText: xhr.statusText,
              headers: headers,
              data,
            });
          } catch (error) {
            displayResult(
              "audioResult",
              {
                error: error.message,
                response: xhr.responseText,
                status: xhr.status,
                statusText: xhr.statusText,
              },
              true
            );
          }
        };

        xhr.onerror = function () {
          const endTime = Date.now();
          displayResult(
            "audioResult",
            {
              error: "Network Error",
              status: xhr.status,
              timeMs: endTime - startTime,
            },
            true
          );
        };

        xhr.send(formData);
      });

      // Custom Request Test
      document.getElementById("addHeader").addEventListener("click", () => {
        const headerContainer = document.getElementById("headerContainer");
        const headerControl = document.createElement("div");
        headerControl.className = "header-control";
        headerControl.innerHTML = `
                <input type="text" class="headerName" placeholder="Header name">
                <input type="text" class="headerValue" placeholder="Header value">
                <button class="removeHeader">-</button>
            `;

        headerContainer.appendChild(headerControl);

        headerControl
          .querySelector(".removeHeader")
          .addEventListener("click", () => {
            headerContainer.removeChild(headerControl);
          });
      });

      // Add remove header functionality to initial header
      document
        .querySelector(".removeHeader")
        .addEventListener("click", function () {
          const headerControl = this.parentElement;
          headerControl.querySelector(".headerName").value = "";
          headerControl.querySelector(".headerValue").value = "";
        });

      // Helper to get custom headers
      function getCustomHeaders() {
        const headers = {};

        document.querySelectorAll(".header-control").forEach((control) => {
          const name = control.querySelector(".headerName").value;
          const value = control.querySelector(".headerValue").value;

          if (name && value) {
            headers[name] = value;
          }
        });

        return headers;
      }

      document
        .getElementById("sendCustomFetch")
        .addEventListener("click", async () => {
          const endpoint = document.getElementById("endpoint").value;
          const method = document.getElementById("method").value;
          const fileInput = document.getElementById("customFile");
          const headers = getCustomHeaders();

          try {
            const startTime = Date.now();

            let options = {
              method: method,
              headers: headers,
              cache: "no-cache",
            };

            // Add body if needed
            if (method !== "GET" && fileInput.files.length) {
              const formData = new FormData();
              formData.append("file", fileInput.files[0]);
              options.body = formData;
            }

            const response = await fetch(`${API_BASE}${endpoint}`, options);

            let data;
            try {
              data = await response.json();
            } catch (e) {
              try {
                data = { rawText: await response.text() };
              } catch (e2) {
                data = { error: "Could not parse response" };
              }
            }

            const endTime = Date.now();

            displayResult("customResult", {
              timeMs: endTime - startTime,
              url: `${API_BASE}${endpoint}`,
              method: method,
              requestHeaders: headers,
              status: response.status,
              statusText: response.statusText,
              responseHeaders: Object.fromEntries([
                ...response.headers.entries(),
              ]),
              data,
            });
          } catch (error) {
            displayResult(
              "customResult",
              {
                error: error.message,
                stack: error.stack,
              },
              true
            );
          }
        });

      document.getElementById("sendCustomXHR").addEventListener("click", () => {
        const endpoint = document.getElementById("endpoint").value;
        const method = document.getElementById("method").value;
        const fileInput = document.getElementById("customFile");
        const headers = getCustomHeaders();

        const xhr = new XMLHttpRequest();
        const startTime = Date.now();

        xhr.open(method, `${API_BASE}${endpoint}`);

        // Add headers
        Object.entries(headers).forEach(([name, value]) => {
          xhr.setRequestHeader(name, value);
        });

        xhr.onload = function () {
          const endTime = Date.now();

          let data;
          try {
            data = JSON.parse(xhr.responseText);
          } catch (e) {
            data = { rawText: xhr.responseText };
          }

          // Get response headers
          const headerString = xhr.getAllResponseHeaders();
          const headerArray = headerString.split("\r\n");
          const responseHeaders = {};
          headerArray.forEach((line) => {
            if (line) {
              const parts = line.split(": ");
              const header = parts.shift();
              const value = parts.join(": ");
              responseHeaders[header] = value;
            }
          });

          displayResult("customResult", {
            timeMs: endTime - startTime,
            url: `${API_BASE}${endpoint}`,
            method: method,
            requestHeaders: headers,
            status: xhr.status,
            statusText: xhr.statusText,
            responseHeaders: responseHeaders,
            data,
          });
        };

        xhr.onerror = function () {
          const endTime = Date.now();
          displayResult(
            "customResult",
            {
              error: "Network Error",
              status: xhr.status,
              timeMs: endTime - startTime,
            },
            true
          );
        };

        // Add body if needed
        if (method !== "GET" && fileInput.files.length) {
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          xhr.send(formData);
        } else {
          xhr.send();
        }
      });
    </script>
  </body>
</html>
